<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AcuCode 3 - Scratch-style Visual Coder</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #blocklyDiv {
      height: 60vh;
      width: 100%;
    }
    #canvas {
      border: 1px solid #ccc;
      width: 100%;
      height: 30vh;
      background: white;
    }
    #buttons {
      margin: 10px;
    }
  </style>
</head>
<body>
  <div id="blocklyDiv"></div>
  <div id="buttons">
    <button onclick="runCode()">Run</button>
    <button onclick="saveWorkspace()">Save</button>
    <button onclick="loadWorkspace()">Load</button>
  </div>
  <canvas id="canvas" width="800" height="300"></canvas>

  <xml id="toolbox" style="display: none">
    <category name="Motion">
      <block type="move_forward"></block>
      <block type="turn_right"></block>
      <block type="turn_left"></block>
    </category>
    <category name="Looks">
      <block type="draw_circle"></block>
      <block type="draw_square"></block>
    </category>
    <category name="Control">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">4</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number"><field name="NUM">0</field></block>
      <block type="math_arithmetic"></block>
    </category>
    <category name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
    </category>
    <category name="Variables" custom="VARIABLE"></category>
  </xml>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox')
    });

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let angle = 0, x = 400, y = 150;

    function resetCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      x = 400;
      y = 150;
      angle = 0;
    }

    Blockly.Blocks['move_forward'] = {
      init: function() {
        this.appendDummyInput().appendField("move forward 50px");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(230);
        this.setTooltip('');
        this.setHelpUrl('');
      }
    };

    Blockly.JavaScript['move_forward'] = function() {
      return `moveForward();\n`;
    };

    Blockly.Blocks['turn_right'] = {
      init: function() {
        this.appendDummyInput().appendField("turn right 90°");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(180);
        this.setTooltip('');
        this.setHelpUrl('');
      }
    };

    Blockly.JavaScript['turn_right'] = function() {
      return `angle += 90;\n`;
    };

    Blockly.Blocks['turn_left'] = {
      init: function() {
        this.appendDummyInput().appendField("turn left 90°");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(180);
        this.setTooltip('');
        this.setHelpUrl('');
      }
    };

    Blockly.JavaScript['turn_left'] = function() {
      return `angle -= 90;\n`;
    };

    Blockly.Blocks['draw_circle'] = {
      init: function() {
        this.appendDummyInput().appendField("draw circle");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(160);
        this.setTooltip('');
        this.setHelpUrl('');
      }
    };

    Blockly.JavaScript['draw_circle'] = function() {
      return `ctx.beginPath();
ctx.arc(x, y, 25, 0, 2 * Math.PI);
ctx.stroke();\n`;
    };

    Blockly.Blocks['draw_square'] = {
      init: function() {
        this.appendDummyInput().appendField("draw square");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(160);
        this.setTooltip('');
        this.setHelpUrl('');
      }
    };

    Blockly.JavaScript['draw_square'] = function() {
      return `ctx.strokeRect(x - 25, y - 25, 50, 50);\n`;
    };

    function moveForward() {
      const radians = angle * (Math.PI / 180);
      const newX = x + Math.cos(radians) * 50;
      const newY = y + Math.sin(radians) * 50;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(newX, newY);
      ctx.stroke();
      x = newX;
      y = newY;
    }

    function runCode() {
      resetCanvas();
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }

    function saveWorkspace() {
      const xml = Blockly.Xml.workspaceToDom(workspace);
      const xmlText = Blockly.Xml.domToText(xml);
      localStorage.setItem("acucode3", xmlText);
      alert("Project saved!");
    }

    function loadWorkspace() {
      const xmlText = localStorage.getItem("acucode3");
      if (xmlText) {
        const xml = Blockly.Xml.textToDom(xmlText);
        Blockly.Xml.domToWorkspace(xml, workspace);
        alert("Project loaded!");
      } else {
        alert("No saved project found.");
      }
    }
  </script>
</body>
</html>
